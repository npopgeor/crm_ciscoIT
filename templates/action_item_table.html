{% if items %}
<div class="table-responsive shadow-sm rounded border mb-5">
  <table class="table table-hover align-middle mb-0 action-table">
    <thead class="table-light text-nowrap">
      <tr class="text-secondary">
        <th>Date</th>
        <th>Detail</th>
        <th>Customer</th>
        <th>Customer Contact</th>
        <th>Cisco Contact</th>
        <th>Status</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {# First loop: OPEN items #}
      {% set open_items = items | selectattr('completed', 'equalto', False) | list %}
      {% set completed_items = items | selectattr('completed', 'equalto', True) | list %}
    
      {% for item in open_items %}
      <tr class="clickable-row" data-href="{{ url_for('edit_action_item', item_id=item.id, tab=active_tab or 'daily') }}">
        <td>{{ item.date }}</td>
        <td>
          <span class="fw-semibold">{{ item.detail }}</span>
          {% if item.updates %}
          <ul class="list-unstyled small mt-2">
            {% for u in item.updates %}
            <li class="text-muted">• <strong>{{ u.timestamp.strftime('%b %d %H:%M') }}</strong> – {{ u.update_text }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </td>
        <td>{{ item.customer.name if item.customer else '' }}</td>
        <td>{{ item.customer_contact }}</td>
        <td>{{ item.cisco_contact }}</td>
        <td><span class="badge bg-warning text-dark">Open</span></td>
        <td class="text-center">
          <a href="{{ url_for('edit_action_item', item_id=item.id, tab=active_tab or 'daily') }}" class="btn btn-sm btn-outline-warning" title="Edit this Action Item">✏️</a>
          <a href="{{ url_for('delete_action_item', item_id=item.id, tab=active_tab or 'daily') }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this item?');" title="Delete this Action Item">🗑️</a>
        </td>
      </tr>
      {% endfor %}
    
      {% if completed_items %}
      <tr>
        <td colspan="7" class="bg-light text-center" style="font-weight: bold; font-size: 1.25rem; padding: 1rem;">
          <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#completedItems" aria-expanded="false" aria-controls="completedItems">
            ✅ Show Completed Items ({{ completed_items | length }})
          </button>
        </td>
      </tr>

      <tbody id="completedItems" class="collapse">
        {% for item in completed_items %}
        <tr class="clickable-row" data-href="{{ url_for('edit_action_item', item_id=item.id, tab=active_tab or 'daily') }}">
          <td>{{ item.date }}</td>
          <td>
            <span class="fw-semibold text-muted">{{ item.detail }}</span>
            {% if item.updates %}
            <ul class="list-unstyled small mt-2">
              {% for u in item.updates %}
              <li class="text-muted">• {{ u.timestamp.strftime('%b %d %H:%M') }} – {{ u.update_text }}</li>
              {% endfor %}
            </ul>
            {% endif %}
          </td>
          <td>{{ item.customer.name if item.customer else '' }}</td>
          <td>{{ item.customer_contact }}</td>
          <td>{{ item.cisco_contact }}</td>
          <td><span class="badge bg-success">Completed</span></td>
          <td class="text-center">
            <a href="{{ url_for('edit_action_item', item_id=item.id, tab=active_tab or 'daily') }}" class="btn btn-sm btn-outline-warning" title="Edit this Action Item">✏️</a>
            <a href="{{ url_for('delete_action_item', item_id=item.id, tab=active_tab or 'daily') }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this item?');" title="Delete this Action Item">🗑️</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
      {% endif %}

    </tbody>
    
  </table>
</div>
{% else %}
  <p class="text-muted">No items found in this category.</p>
{% endif %}
