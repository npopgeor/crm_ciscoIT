{% extends 'layout.html' %}

{% macro render_tree(contact, seen) %}
  {% if contact.id not in seen %}
    {% set _ = seen.append(contact.id) %}
    <li>
      {{ contact.name }} â€“ {{ contact.role }}
      {% if contact.email %}
        (<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>)
      {% endif %}
      {% if contact.subordinates %}
        <ul>
          {% for sub in contact.subordinates %}
            {{ render_tree(sub, seen) }}
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {% endif %}
{% endmacro %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ customer.name }}</h2>
    <a href="{{ url_for('edit_customer', id=customer.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
  </div>

  {% if customer.notes %}
    <p><strong>Notes:</strong> {{ customer.notes }}</p>
  {% endif %}

  {% if customer.partners %}
    <p><strong>Partners:</strong>
      {% for partner in customer.partners %}
        <a href="{{ url_for('partner_detail', partner_id=partner.id) }}">{{ partner.name }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  {% if customer.opportunities %}
    <p><strong>Opportunities:</strong>
      {% for opp in customer.opportunities %}
        {{ opp.title }} ({{ opp.stage }}){% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  {% if customer.technologies %}
    <p><strong>Technologies:</strong>
      {% for tech in customer.technologies %}
        {{ tech.name }} â€“ {{ tech.discount_level }}%{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  {% if customer.projects %}
    <p><strong>Projects:</strong>
      {% for proj in customer.projects %}
        {{ proj.name }} ({{ proj.status }}){% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  <!-- Contacts Section -->
  <div class="mt-4">
    <div class="card p-3">
      <a class="d-flex justify-content-between align-items-center text-decoration-none text-dark"
         data-bs-toggle="collapse"
         href="#contactCollapse"
         role="button"
         aria-expanded="false"
         aria-controls="contactCollapse">
        <h5 class="mb-0">ðŸ‘¥ Contacts</h5>
        <span class="text-primary small">Show/Hide</span>
      </a>
      <div class="collapse" id="contactCollapse">
        <div class="mt-3">
          {% if contact_tree %}
            <ul class="tree">
              {% for contact in contact_tree if not contact.reports_to %}
                {{ render_tree(contact, []) }}
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">No contacts available.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Attachments Block -->


  <div class="row mt-4">
    <div class="col-md-6 col-xl-4">
      <div class="card p-3 h-100" style="cursor: pointer;" onclick="window.location='{{ url_for('customer_attachments', id=customer.id) }}'">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">ðŸ“Ž Attachments</h5>
          <small class="text-primary">View & Manage âž”</small>
        </div>
        {% if total_attachments > 0 %}
          <p class="mb-0">
            <span class="fw-bold fs-4 text-primary">{{ total_attachments }}</span>
            attachment{{ 's' if total_attachments > 1 else '' }} uploaded
          </p>
        {% else %}
          <p class="text-muted mb-0">No attachments uploaded yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
  

</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.addEventListener("keydown", function (event) {
      if ((event.key === "Escape" || event.keyCode === 27) &&
          document.activeElement.tagName !== "TEXTAREA" &&
          document.activeElement.tagName !== "INPUT") {
        
        event.preventDefault(); // Prevent default Escape behavior (like modal close)
        console.log("Forced redirect on Esc");

        setTimeout(() => {
          window.location.href = "/dashboard";  // âœ… Change this per page
        }, 100);
      }
    });
  });
</script>



{% endblock %}
