{% extends 'layout.html' %}
{% block content %}
<div class="container py-5">

  <!-- Add Progress Update (TOP) -->
  <h5 class="mb-3">➕ Add Progress Update</h5>
  <form method="POST" action="{{ url_for('add_action_item_update', item_id=item.id) }}">
    <textarea name="update_text" class="form-control mb-2" placeholder="What’s the update?" rows="3" required></textarea>
    <button type="submit" class="btn btn-outline-success btn-sm">Add Progress</button>
  </form>

  <!-- Update History -->
  {% if item.updates %}
  <div class="card mt-4">
    <div class="card-header bg-light fw-bold">📜 Update History</div>
    <ul class="list-group list-group-flush">
      {% for u in item.updates %}
      <li class="list-group-item">
        <div class="text-muted small mb-2">{{ u.timestamp.strftime('%b %d, %Y %I:%M %p') }}</div>

        <div class="d-flex gap-2">
          <form method="POST" action="{{ url_for('edit_action_item_update', update_id=u.id) }}" class="d-flex flex-grow-1 align-items-start gap-2">
            <input type="hidden" name="item_id" value="{{ item.id }}">
            <textarea name="update_text" class="form-control form-control-sm" rows="2">{{ u.update_text }}</textarea>
            <button type="submit" class="btn btn-sm btn-outline-primary">💾</button>
          </form>

          <form method="POST" action="{{ url_for('delete_action_item_update', update_id=u.id) }}" onsubmit="return confirm('Delete this update?');">
            <input type="hidden" name="item_id" value="{{ item.id }}">
            <button type="submit" class="btn btn-sm btn-outline-danger">🗑️</button>
          </form>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
<!-- Main Action Item Update Form -->
<form method="POST" id="actionForm" class="mt-5">
  <div class="row align-items-center mb-4">
    
    <!-- Left: Title -->
    <div class="col-md-4 col-sm-12 mb-2 mb-md-0">
      <h2 class="mb-0">📝 Edit Action Item</h2>
    </div>

    <!-- Center: Category Dropdown -->
    <div class="col-md-4 col-sm-12 d-flex flex-column align-items-md-center align-items-start">
      <label for="category" class="form-label mb-1">Category</label>
      <select name="category" id="category" class="form-select w-auto">
        <option value="daily" {% if item.category == 'daily' %}selected{% endif %}>Day-to-Day</option>
        <option value="strategic" {% if item.category == 'strategic' %}selected{% endif %}>Strategic</option>
      </select>
    </div>

    <!-- Right: Completed + Buttons -->
    <div class="col-md-4 col-sm-12 d-flex justify-content-md-end flex-wrap gap-3 align-items-center mt-3 mt-md-0">
      <div class="form-check d-flex align-items-center" style="gap: 0.5rem;">
        <input type="checkbox"
               class="form-check-input"
               id="completed"
               name="completed"
               style="transform: scale(2); margin-right: 12px;"
               {% if item.completed %}checked{% endif %}>
        <label class="form-check-label fs-3" for="completed">Completed</label>
      </div>
      
      <button type="submit" class="btn btn-warning">Update</button>
      <a href="{{ url_for('action_item_list', tab=active_tab or 'daily') }}" class="btn btn-link">⬅️ Back</a>
    </div>

  </div>

    

    <div class="mb-3">
      <label class="form-label">Date</label>
      <input type="date" name="date" value="{{ item.date }}" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Detail</label>
      <textarea name="detail" class="form-control" required>{{ item.detail }}</textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Customer</label>
      <select name="customer_id" class="form-select" required>
        {% for customer in customers %}
        <option value="{{ customer.id }}" {% if customer.id == item.customer_id %}selected{% endif %}>{{ customer.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Customer Contact</label>
      <input name="customer_contact" value="{{ item.customer_contact }}" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Cisco Contact</label>
      <input name="cisco_contact" value="{{ item.cisco_contact }}" class="form-control">
    </div>
  </form>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.addEventListener("keydown", function (event) {
      // Make sure no accidental submits interfere
      if ((event.key === "Escape" || event.keyCode === 27) &&
          document.activeElement.tagName !== "TEXTAREA" &&
          document.activeElement.tagName !== "INPUT") {
        
        event.preventDefault(); // <--- Important: stop any browser default handling
        console.log("Forced redirect on Esc");

        setTimeout(() => {
          window.location.href = "/action_items";
        }, 100); // Short delay to let DOM settle (just in case)
      }
    });
  });
</script>


{% endblock %}
