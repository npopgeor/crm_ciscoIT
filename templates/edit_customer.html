{% extends 'layout.html' %}
{% block content %}

<div class="pt-3">
  <h2>Edit Customer</h2>

  <form method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="name" class="form-label">Name</label>
      <input type="text" class="form-control" id="name" name="name" value="{{ customer.name }}" required>
    </div>

    <div class="mb-3">
      <label for="cx_services" class="form-label">CX Services</label>
      <textarea class="form-control" id="cx_services" name="cx_services">{{ customer.cx_services }}</textarea>
    </div>

    <div class="mb-3">
      <label for="notes" class="form-label">Notes</label>
      <textarea class="form-control" id="notes" name="notes">{{ customer.notes }}</textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Upload/Update Logo (.png)</label>
      <input type="file" name="logo" class="form-control" accept="image/png">
    </div>

    <button type="submit" class="btn btn-primary">💾 Save Changes</button>
    <a href="{{ url_for('customer_detail', id=customer.id) }}" class="btn btn-secondary ms-2">Cancel</a>
  </form>

  <hr>

  <div class="mt-5">
    <a href="{{ url_for('add_division', customer_id=customer.id) }}" class="btn btn-outline-primary mb-2">➕ Add Division</a>

    {% set assigned_contact_ids = [] %}
    {% for division in customer.divisions if division.parent_id %}
    <div class="border rounded p-4 mb-4 bg-white shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">📁 {{ division.name }}</h5>
        <a href="{{ url_for('delete_division', division_id=division.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?');">🗑 Delete</a>
      </div>

      <div class="mb-3">
        <h6>💼 Opportunities</h6>
        <a href="{{ url_for('add_division_opportunity', division_id=division.id) }}" class="btn btn-sm btn-outline-primary mb-2">➕ Add</a>
        {% if division.opportunities %}
        <ul>
          {% for opp in division.opportunities %}
            <li>{{ opp.title }} – {{ opp.stage }} ({{ opp.value }})
              <a href="{{ url_for('edit_division_opportunity', id=opp.id) }}" class="btn btn-sm btn-outline-warning">✏️</a>
              <a href="{{ url_for('delete_division_opportunity', id=opp.id) }}" class="btn btn-sm btn-outline-danger">🗑</a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p class="text-muted">No opportunities</p>
        {% endif %}
      </div>

      <div class="mb-3">
        <h6>⚙️ Technologies</h6>
        <a href="{{ url_for('add_division_technology', division_id=division.id) }}" class="btn btn-sm btn-outline-primary mb-2">➕ Add</a>
        {% if division.technologies %}
        <ul>
          {% for tech in division.technologies %}
            <li>{{ tech.name }} – {{ tech.discount_level }}%
              <a href="{{ url_for('edit_division_technology', id=tech.id) }}" class="btn btn-sm btn-outline-warning">✏️</a>
              <a href="{{ url_for('delete_division_technology', id=tech.id) }}" class="btn btn-sm btn-outline-danger">🗑</a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p class="text-muted">No technologies</p>
        {% endif %}
      </div>

      <div class="mb-3">
        <h6>🛠 Projects</h6>
        <a href="{{ url_for('add_division_project', division_id=division.id) }}" class="btn btn-sm btn-outline-primary mb-2">➕ Add</a>
        {% if division.projects %}
        <ul>
          {% for proj in division.projects %}
            <li>{{ proj.name }} – {{ proj.status }} ({{ proj.owner }})
              <a href="{{ url_for('edit_division_project', id=proj.id) }}" class="btn btn-sm btn-outline-warning">✏️</a>
              <a href="{{ url_for('delete_division_project', id=proj.id) }}" class="btn btn-sm btn-outline-danger">🗑</a>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p class="text-muted">No projects</p>
        {% endif %}
      </div>

      <form method="POST" action="{{ url_for('assign_contacts_to_division', division_id=division.id) }}">
        <div class="mb-3">
          <label class="form-label">Assign Contacts</label>
          <div class="row">
            {% for contact in available_contacts %}
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="contact_ids" value="{{ contact.id }}"
                       {% if contact in division.contacts %}checked{% endif %}>
                <label class="form-check-label">{{ contact.name }} ({{ contact.role }})</label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <button type="submit" class="btn btn-sm btn-success">✅ Save Contacts</button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}
