{% extends 'layout.html' %}
{% block content %}

<h2 class="mb-4">üè¢ {{ customer.name }}</h2>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="customerTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup" type="button" role="tab">Setup</button>
  </li>
</ul>

<div class="tab-content" id="customerTabsContent">
  <!-- Overview Tab -->
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row">
      <div class="col-lg-8">
        <div class="mb-4">
          <p><strong>CX Services:</strong> {{ customer.cx_services }}</p>
          <p><strong>Notes:</strong> {{ customer.notes }}</p>
        </div>

        <!-- Customer-Level Opportunities -->
      <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">üíº Customer Opportunities</h4>
          <a href="{{ url_for('add_customer_opportunity', customer_id=customer.id) }}" class="btn btn-sm btn-outline-primary">‚ûï Add</a>
        </div>
        {% if customer.opportunities %}
        <table class="table table-sm table-striped">
          <thead><tr><th>Title</th><th>Value</th><th>Stage</th><th>Notes</th><th></th></tr></thead>
          <tbody>
            {% for opp in customer.opportunities %}
            <tr>
              <td>{{ opp.title }}</td>
              <td>{{ opp.value }}</td>
              <td>{{ opp.stage }}</td>
              <td>{{ opp.notes }}</td>
              <td class="text-end">
                <a href="{{ url_for('edit_customer_opportunity', id=opp.id) }}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
                <a href="{{ url_for('delete_customer_opportunity', id=opp.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this opportunity?');">üóë</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted">No opportunities.</p>
        {% endif %}
      </div>

      <!-- Customer Technologies -->
      <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">‚öôÔ∏è Customer Technologies</h4>
          <a href="{{ url_for('add_customer_technology', customer_id=customer.id) }}" class="btn btn-sm btn-outline-primary">‚ûï Add</a>
        </div>
        {% if customer.technologies %}
        <table class="table table-sm table-striped">
          <thead><tr><th>Name</th><th>Discount</th><th>Notes</th><th></th></tr></thead>
          <tbody>
            {% for tech in customer.technologies %}
            <tr>
              <td>{{ tech.name }}</td>
              <td>{{ tech.discount_level }}%</td>
              <td>{{ tech.notes }}</td>
              <td class="text-end">
                <a href="{{ url_for('edit_customer_technology', id=tech.id) }}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
                <a href="{{ url_for('delete_customer_technology', id=tech.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this technology?');">üóë</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted">No technologies.</p>
        {% endif %}
      </div>

      <!-- Customer Projects -->
      <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">üõ† Customer Projects</h4>
          <a href="{{ url_for('add_customer_project', customer_id=customer.id) }}" class="btn btn-sm btn-outline-primary">‚ûï Add</a>
        </div>
        {% if customer.projects %}
        <table class="table table-sm table-striped">
          <thead><tr><th>Name</th><th>Status</th><th>Owner</th><th>Notes</th><th></th></tr></thead>
          <tbody>
            {% for proj in customer.projects %}
            <tr>
              <td>{{ proj.name }}</td>
              <td>{{ proj.status }}</td>
              <td>{{ proj.owner }}</td>
              <td>{{ proj.notes }}</td>
              <td class="text-end">
                <a href="{{ url_for('edit_customer_project', id=proj.id) }}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
                <a href="{{ url_for('delete_customer_project', id=proj.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this project?');">üóë</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted">No projects.</p>
        {% endif %}
      </div>


        {% set visible_divisions = customer.divisions | selectattr('parent_id', '!=', None) | list %}

        {% if visible_divisions %}
        <div class="mb-5">
          <h4>üíº Opportunities by Division</h4>
          {% for division in visible_divisions %}
            {% if division.opportunities %}
              <h6 class="mt-3">{{ division.name }}</h6>
              <ul>
                {% for opp in division.opportunities %}
                  <li><strong>{{ opp.title }}</strong> ‚Äî {{ opp.stage }} ‚Äî {{ opp.value }}<br><small class="text-muted">{{ opp.notes }}</small></li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endfor %}
        </div>

        <div class="mb-5">
          <h4>‚öôÔ∏è Technologies by Division</h4>
          {% for division in visible_divisions %}
            {% if division.technologies %}
              <h6 class="mt-3">{{ division.name }}</h6>
              <ul>
                {% for tech in division.technologies %}
                  <li><strong>{{ tech.name }}</strong> ‚Äî {{ tech.discount_level }}%<br><small class="text-muted">{{ tech.notes }}</small></li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endfor %}
        </div>

        <div class="mb-5">
          <h4>üõ† Projects by Division</h4>
          {% for division in visible_divisions %}
            {% if division.projects %}
              <h6 class="mt-3">{{ division.name }}</h6>
              <ul>
                {% for proj in division.projects %}
                  <li><strong>{{ proj.name }}</strong> ‚Äî {{ proj.status }} ‚Äî Owner: {{ proj.owner }}<br><small class="text-muted">{{ proj.notes }}</small></li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}

        {% if visible_divisions %}
        <div class="mb-5">
          <h4>üß≠ Divisions</h4>
          <ul class="list-group">
            {% for division in visible_divisions %}
            <li class="list-group-item">
              üìÅ <a href="{{ url_for('division_detail', division_id=division.id) }}" class="fw-semibold text-decoration-none">{{ division.name }}</a>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if not visible_divisions and contact_tree %}
        <div class="mb-3 border rounded">
          <button class="btn btn-link text-start w-100 p-3" type="button" data-bs-toggle="collapse" data-bs-target="#customerContactsCollapse" aria-expanded="false" aria-controls="customerContactsCollapse">
            <h5 class="mb-0">üìá Associated Contacts <span class="text-muted" style="font-size: 0.9rem;">(click to expand)</span></h5>
          </button>
          <div class="collapse" id="customerContactsCollapse">
            <div class="p-3">
              <ul class="mb-0">
                {% for contact in contact_tree %}
                <li>
                  üë§ <strong>{{ contact.name }}</strong> ‚Äî
                  <span class="text-muted">{{ contact.role }}</span>
                  {% if contact.email %}
                  ‚Äî <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                  {% endif %}

                  {% if contact.subordinates %}
                  <ul class="mt-2 ms-4">
                    {% for subordinate in contact.subordinates %}
                    <li>
                      ‚Ü≥ <strong>{{ subordinate.name }}</strong> ‚Äî
                      <span class="text-muted">{{ subordinate.role }}</span>
                      {% if subordinate.email %}
                      ‚Äî <a href="mailto:{{ subordinate.email }}">{{ subordinate.email }}</a>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>

        <!-- Uploaded Files -->
        {% set file_divisions = customer.divisions | selectattr('document', '!=', None) | list %}
        {% if file_divisions %}
        <div class="mb-3 p-3 border rounded">
          <h5 class="mb-2">üìé Uploaded Files</h5>
          <ul class="mb-0">
            {% for div in file_divisions %}
            <li>
              üìÑ <a href="{{ url_for('uploaded_file', filename=div.document) }}" target="_blank">{{ div.document }}</a>
              <small class="text-muted ms-2">({{ div.name }})</small>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Upload Form -->
        <div class="mb-3 p-3 border rounded bg-light">
          <h5 class="mb-2">üì§ Upload File</h5>
          <form action="{{ url_for('upload_customer_file', id=customer.id) }}" method="POST" enctype="multipart/form-data">
            <div class="mb-2">
              <label class="form-label">File</label>
              <input type="file" name="file" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Optional Title</label>
              <input type="text" name="division_name" class="form-control" placeholder="e.g. Contract, Pricing, etc.">
            </div>
            <button type="submit" class="btn btn-sm btn-success">üìé Upload</button>
          </form>
        </div>
        {% endif %}

        <div class="mb-5">
          <h4>üîÅ Recurring Meetings</h4>
          <ul>
            {% for meeting in customer.recurring_meetings %}
              <li>{{ meeting.title }} - {{ meeting | recurrence_display }}</li>
            {% endfor %}
          </ul>
        </div>

        <a href="/customers" class="btn btn-link">‚¨Ö Back to Customers</a>
      </div>

      <div class="col-lg-4">
        <div class="card card-body bg-light">
          <h5 class="mb-4 fw-bold text-dark" style="font-size: 1.25rem;">üìä Summary</h5>

          <div class="mb-4">
            <h6 class="fw-bold text-primary mb-2" style="font-size: 1.05rem;">üîÅ Recurring Meetings</h6>
            {% set enriched_meetings = customer.get_enriched_recurring_meetings() %}
            {% if enriched_meetings %}
              <ul class="ps-3 mb-0">
                {% for r in enriched_meetings %}
                  <li class="mb-2">
                    <strong class="d-block">{{ r.title }}</strong>
                    <span class="text-muted small">
                      {{ r.recurrence }}<br>
                      Next: {{ r.next }}
                    </span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted ps-3 mb-0">None scheduled</p>
            {% endif %}
          </div>

          <hr class="my-3">

          <div>
            <h6 class="fw-bold text-primary mb-2" style="font-size: 1.05rem;">üìù Open Action Items</h6>
            <p class="ps-3 mb-0">
              <a href="{{ url_for('action_item_list', customer_id=customer.id) }}" class="text-decoration-none">
                <span class="fw-bold" style="font-size: 1.2rem;">
                  {{ customer.action_items | selectattr('completed', 'equalto', False) | list | length }}
                </span>
                open
              </a>
            </p>
          </div>

        </div>
      </div>
    </div>
  </div>


  <!-- Setup Tab -->
  <div class="tab-pane fade" id="setup" role="tabpanel">
    <div class="my-4">
      <a href="{{ url_for('edit_customer', id=customer.id) }}" class="btn btn-outline-warning mb-3">‚úèÔ∏è Edit Customer</a>
      <a href="{{ url_for('add_division', customer_id=customer.id) }}?from=setup" class="btn btn-outline-primary mb-3">‚ûï Add Division</a>
    </div>

    {% set assigned_contact_ids = [] %}  {# ‚Üê Add this line #}

    {% for division in customer.divisions if division.parent_id %}
    <div class="border rounded p-4 mb-4 bg-white shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">üìÅ {{ division.name }}</h5>
        <a href="{{ url_for('delete_division', division_id=division.id) }}?from=setup" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this division?');">üóë Delete</a>
      </div>

      <!-- Opportunities -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">üíº Opportunities</h6>
          <a href="{{ url_for('add_division_opportunity', division_id=division.id) }}?from=setup" class="btn btn-sm btn-outline-primary">‚ûï</a>
        </div>
        {% if division.opportunities %}
        <table class="table table-sm table-striped">
          <thead><tr><th>Title</th><th>Value</th><th>Stage</th><th>Notes</th><th></th></tr></thead>
          <tbody>
            {% for opp in division.opportunities %}
            <tr>
              <td>{{ opp.title }}</td><td>{{ opp.value }}</td><td>{{ opp.stage }}</td><td>{{ opp.notes }}</td>
              <td class="text-end">
                <a href="{{ url_for('edit_division_opportunity', id=opp.id) }}?from=setup" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
                <a href="{{ url_for('delete_division_opportunity', id=opp.id) }}?from=setup" class="btn btn-sm btn-outline-danger">üóë</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}<p class="text-muted">No opportunities</p>{% endif %}
      </div>

      <!-- Technologies -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">‚öôÔ∏è Technologies</h6>
          <a href="{{ url_for('add_division_technology', division_id=division.id) }}?from=setup" class="btn btn-sm btn-outline-primary">‚ûï</a>
        </div>
        {% if division.technologies %}
        <table class="table table-sm table-striped">
          <thead><tr><th>Name</th><th>Discount</th><th>Notes</th><th></th></tr></thead>
          <tbody>
            {% for tech in division.technologies %}
            <tr>
              <td>{{ tech.name }}</td><td>{{ tech.discount_level }}%</td><td>{{ tech.notes }}</td>
              <td class="text-end">
                <a href="{{ url_for('edit_division_technology', id=tech.id) }}?from=setup" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
                <a href="{{ url_for('delete_division_technology', id=tech.id) }}?from=setup" class="btn btn-sm btn-outline-danger">üóë</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}<p class="text-muted">No technologies</p>{% endif %}
      </div>

      <!-- Projects -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">üõ† Projects</h6>
          <a href="{{ url_for('add_division_project', division_id=division.id) }}?from=setup" class="btn btn-sm btn-outline-primary">‚ûï</a>
        </div>
        {% if division.projects %}
        <table class="table table-sm table-striped">
          <thead><tr><th>Name</th><th>Status</th><th>Owner</th><th>Notes</th><th></th></tr></thead>
          <tbody>
            {% for proj in division.projects %}
            <tr>
              <td>{{ proj.name }}</td><td>{{ proj.status }}</td><td>{{ proj.owner }}</td><td>{{ proj.notes }}</td>
              <td class="text-end">
                <a href="{{ url_for('edit_division_project', id=proj.id) }}?from=setup" class="btn btn-sm btn-outline-warning">‚úèÔ∏è</a>
                <a href="{{ url_for('delete_division_project', id=proj.id) }}?from=setup" class="btn btn-sm btn-outline-danger">üóë</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}<p class="text-muted">No projects</p>{% endif %}
      </div>

      <!-- Contact Assignment -->
      <!-- Contact Assignment -->
      <form method="POST" action="{{ url_for('assign_contacts_to_division', division_id=division.id) }}">
        <div class="mb-3">
          <label class="form-label">Assign Contacts</label>
          <div class="row">
            {% for contact in available_contacts %}
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="contact_ids" value="{{ contact.id }}"
                  {% if contact in division.contacts %}checked{% endif %}>
                <label class="form-check-label">
                  {{ contact.name }} ({{ contact.role }})
                </label>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <button type="submit" class="btn btn-sm btn-success">‚úÖ Save Contacts</button>
      </form>

      {% for c in division.contacts %}
        {% if c.id not in assigned_contact_ids %}
          {% set _ = assigned_contact_ids.append(c.id) %}
        {% endif %}
      {% endfor %}

      
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}
